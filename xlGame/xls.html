<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>xlGame</title>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <link rel="stylesheet" type="text/css" href="xlGame.css">
</head>
<body>
    <div id="questionDiv" style="font-size:x-large">Loading...</div>
    <br />
    <div id="results"></div> <button onclick="btnNextClick()">Next>></button>
    <br />
    <div id="excelDivParent">
        <div id="excelDiv"></div>
    </div>
    <div id="userDiv" class="userDiv">
        Your score: <div id="noOfLabels" class="userScore">0</div>
        <br />
        Fill in your email
        <br />
        <input id="userEmail" type="text" />
    </div>
    <script type="text/javascript" src="http://r.office.microsoft.com/r/rlidExcelWLJS?v=1&kip=1"></script>
    <script type="text/javascript">
        //TODO: what if a label cell is selected as a question cell?
        var xlsToken = null; //the SkyDrive filetoken string
        var ewa = null; //the Excel Services Web Part
        var workbook = null //the active workbook
        var questionCell = null; //the cell to be labeled
        var labels = []; //list with the labels the user has clicked, each represented as a tuple eg "C3, value"
        var remainingCells; //the number of cells to be labeled before changing workbook
        var userScore = 0;
        
        if (window.attachEvent) {
            window.attachEvent("onload", loadEwaOnPageLoad);
        } else {
            window.addEventListener("DOMContentLoaded", loadEwaOnPageLoad, false);
        }

        function initCollectors() {
            selectQuestionCell();
            labels = [];
            //de-color cells
            workbook.getRangeA1Async("hidden!A2", setHiddenValue, "");
            $("#results").html("");
        }

        function loadEwaOnPageLoad() {
            postData(true);
        }

        function btnNextClick() {
            $("#questionDiv").html("What is...");
            remainingCells--;
            if (remainingCells < 0) {
                //Change worksheet
                postData(true);
            } else {
                //Change question cell in the same worksheet
                postData(false);
                initCollectors();
            }
        }

        function postData(changeXls) {
            var data = {};

            if (labels.length > 0) {
                data = {
                    spreadsheet: workbook.getWorkbookPath(),
                    xlsToken: xlsToken,
                    cell: questionCell.getAddressA1(),
                    userEmail: $("#userEmail").val(),
                    labels: labels
                };
            }

            posting = $.post("get.aspx", data);

            posting.done(function (resp) {
                if (changeXls) {
                    xlsToken = resp.xls;
                    loadExcel(xlsToken);
                    remainingCells = Math.floor(Math.random() * 3) + 2; //TODO: set number of tries before worksheet change, now 2 to 2+(3-1) = 4
                }
            });
        }

        function loadExcel(token) {

            var props = {
                uiOptions: {
                    showGridlines: true,
                    showRowColumnHeaders: true,
                    showParametersTaskPane: true
                },
                interactivityOptions: {
                    allowTypingAndFormulaEntry: false,
                    allowParameterModification: false,
                    allowSorting: false,
                    allowFiltering: false,
                    allowPivotTableInteractivity: false
                }
            };

            $("#excelDiv").remove();
            $("#excelDivParent").append("<div id=\"excelDiv\" style=\"width: 1000px; height: 600px\"></div>");

            Ewa.EwaControl.loadEwaAsync(token, "excelDiv", props, onExcelLoaded);
        }

        function onExcelLoaded(result) {
            ewa = Ewa.EwaControl.getInstances().getItem(Ewa.EwaControl.getInstances().getCount() - 1);
            workbook = ewa.getActiveWorkbook();
            ewa.add_activeCellChanged(onCellSelectionChange);
            initCollectors();
        }

        function selectQuestionCell() {
            var qCell = randomCell();
            questionCell = workbook.getRange(workbook.getActiveSheet().getName(), qCell.row, qCell.column, 1, 1);
            questionCell.getValuesAsync(1, checkNonEmpty, null);
        }

        function checkNonEmpty(asyncResult) {
            var value = asyncResult.getReturnValue()[0][0];
            if (value == "") {
                //select another cell
                selectQuestionCell();
            } else {
                //set value to hidden!A1 to make confitional formatting color the ewaCell
                workbook.getRangeA1Async("hidden!A1", setHiddenValue, questionCell.getAddressA1() + ",");
                $("#questionDiv").html("What is <div class=\"questionCell\">" + asyncResult.getReturnValue()[0][0] + "</div> in " + questionCell.getAddressA1().split("!")[1] + "?");
            }
        }

        // Handle the active cell changed event.
        function onCellSelectionChange(rangeArgs) {
            var cell = workbook.getActiveCell();
            cell.getValuesAsync(1, updateLabels, cell);
        }

        function updateLabels(asyncResult) {
            var cellValue = asyncResult.getReturnValue()[0][0];
            if (cellValue == "") {
                return;
            }

            var cellAddr = asyncResult.getUserContext().getAddressA1().split("!")[1];
            var index = indexOfLabel(cellAddr);
            if (index >= 0) { //Cell already in list, de-selected -> remove from labels
                labels.splice(index, 1);
                userScore--;
            }
            else { //Cell selected -> add to labels
                labels[labels.length] = [cellAddr, "\"" + cellValue + "\""];
                userScore++;
            }
            updateLabelColors();
            $("#results").html("It is <div class=\"labelCell\">" + getLabelsStr(1, "</div> <div class=\"labelCell\">") + "</div>");
            $("#noOfLabels").html(userScore);
        }

        function indexOfLabel(cellAddr) {
            for (var i = 0; i < labels.length; i++) {
                if (labels[i][0] == cellAddr) {
                    return(i);
                }
            }
            return(-1);
        }

        function updateLabelColors() {
            workbook.getRangeA1Async("hidden!A2", setHiddenValue, getLabelsStr(0, ","));
        }

        function setHiddenValue(asyncResult) {
            asyncResult.getReturnValue().setValuesAsync([[asyncResult.getUserContext()]], setRangeValues, null);
        }

        function setRangeValues(asyncResult) {
        }

        function getLabelsStr(index, delimeter) {
            var labelsList = "";
            for (var i = 0; i < labels.length; i++) {
                labelsList += labels[i][index] + delimeter;
            };
            return labelsList;
        }

        function randomCell(){
            var r = Math.floor(Math.random() * 10); //TODO: set constant to max number of visible rows
            var c = Math.floor(Math.random() * 15); //TODO: set constant to max number of visible columns
            return {
                row: r,
                column: c
            };
        }

    </script>
    </body>
</html>

<!--
    1. Add xls files to corpus skyDrive folder
    2. Make them all public (otherwise, the file token will require an authid which we cannot obtain programnmatically)
    3. In http://isdk.dev.live.com/dev/isdk/ISDK.aspx?category=scenarioGroup_core_concepts&index=0 run code:
    
WL.init({ client_id: clientId, redirect_uri: redirectUri });

WL.login({ "scope": "wl.skydrive" }).then(
    function(response) {
        getFiles();
    },
    function(response) {
        log("Could not connect, status = " + response.status);
    }
);

function getFiles() {
    var files_path = "folder.072e74b1abfc5464.72E74B1ABFC5464!190/files";
    WL.api({ path: files_path, method: "GET" }).then(
        onGetFilesComplete,
        function(response) {
            log("Cannot get files and folders: " +
                JSON.stringify(response.error).replace(/,/g, ",\n"));
        }
    );
}

function onGetFilesComplete(response) {
    var items = response.data;
    for (var i = 0; i < items.length; i++) {
        log(items[i].name + "#" + items[i].id)
               // JSON.stringify(items[i]).replace(/,/g, ",\n"));
       // if (items[i].type === "folder") {
       //     log("Found a folder with the following information: " +
       //         JSON.stringify(items[i]).replace(/,/g, ",\n"));
       //     foundFolder = 1;
       //     break;
       // }
    }
}
                     
function log(message) {
    var child = document.createTextNode(message);
    var parent = document.getElementById('JsOutputDiv') || document.body;
    parent.appendChild(child);
    parent.appendChild(document.createElement("br"));
}

    4. Place result in input.txt
-->