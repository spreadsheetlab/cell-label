<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
</head>
<body>
    <div id="questionCell" style="font-size:x-large">Loading...</div>
    <br />
    <div id="excelDiv" style="width: 1000px; height: 300px"></div>
    <button onclick="btnNextClick()">Next >></button>
    <script type="text/javascript" src="http://r.office.microsoft.com/r/rlidExcelWLJS?v=1&kip=1"></script>
    <script type="text/javascript">
        /*
	     * This code uses the Microsoft Office Excel Javascript object model to programmatically insert the
	     * Excel Web App into a div with id=excelDiv. The full API is documented at
	     * http://msdn.microsoft.com/en-US/library/hh315812.aspx.
	     */

        //TODO on spredsheets: 
        //- Seperate worksheets in different files
        //- Add hidden worksheet named hidden
        //- Add the 2 conditional formating rules
        var spToken = null; //the SkyDrive filetoken string
        var workbook = null //the active workbook
        var questionCell = null; //the cell to be labeled
        var labels = []; //list with the labels the user has clicked, each represented as a tuple eg "C3, value"
        
        // run the Excel load handler on page load
        if (window.attachEvent) {
            window.attachEvent("onload", loadEwaOnPageLoad);
        } else {
            window.addEventListener("DOMContentLoaded", loadEwaOnPageLoad, false);
        }

        function loadEwaOnPageLoad() {
            loadAnExcel(); //TODO: Select a random excel 
        }

        function loadAnExcel() {
            spToken = "SD72E74B1ABFC5464!174/517479313637659748/t=0&s=0&v=!AJSE_-A1i3_eaC8";

            var props = {
                uiOptions: {
                    showGridlines: true,
                    showRowColumnHeaders: true,
                    selectedCell: "'Sheet1'!C3", //TODO: select a random cell
                    showParametersTaskPane: true
                },
                interactivityOptions: {
                    allowTypingAndFormulaEntry: false,
                    allowParameterModification: false,
                    allowSorting: false,
                    allowFiltering: false,
                    allowPivotTableInteractivity: false
                }
            };

            Ewa.EwaControl.loadEwaAsync(spToken, "excelDiv", props, onExcelLoaded);
        }

        function onExcelLoaded(result) {
            var ewa = Ewa.EwaControl.getInstances().getItem(0); //the Excel Services Web Part
            workbook = ewa.getActiveWorkbook();

            selectQuestionCell();
            // Add  event handler for the cell change event
            //ewa.add_activeCellChanged(onCellSelectionChange);
            ewa.add_activeSelectionChanged(onCellSelectionChange);
        }

        function selectQuestionCell() {
            //    var currentSheet = workbook.getActiveSheet().getName();
            //    var range = workbook.getRange(currentSheet, 0,0,1,1);
            //    range.activateAsync(0, 0, rangeActivated, null);
            questionCell = workbook.getActiveCell();
            //set value to hidden!A1 to make confitional formatting color the questionCell
            workbook.getRangeA1Async("hidden!A1", setHiddenValue, questionCell.getAddressA1() + ",");
            //set header question
            questionCell.getValuesAsync(1, setQuestionCellHeader, null);
        }

        function setQuestionCellHeader(asyncResult) {
            document.getElementById("questionCell").innerHTML = "What is " + asyncResult.getReturnValue()[0][0] + " in " + questionCell.getAddressA1() + "?";
        }

        //function rangeActivated() {
        //}

        // Handle the active cell changed event.
        function onCellSelectionChange(rangeArgs) {
            //TODO: support for multiple cell selection
            var cell = workbook.getActiveCell();
            cell.getValuesAsync(1, updateLabels, cell);
        }

        function updateLabels(asyncResult) {
            var cellAddr = asyncResult.getUserContext().getAddressA1().split("!")[1];
            var index = indexOfLabel(cellAddr);
            if (index >= 0) { //Cell already in list, de-selected -> remove from labels
                labels.splice(index, 1);
            }
            else { //Cell selected -> add to labels
                labels[labels.length] = [cellAddr, asyncResult.getReturnValue()[0][0]];
            }
            updateLabelColors();
            document.getElementById("results").innerHTML = getLabelsStr("<br>");
            //TODO! only if it is not because of sheet change
        }

        function indexOfLabel(cellAddr) {
            for (var i = 0; i < labels.length; i++) {
                if (labels[i][0] == cellAddr) {
                    return(i);
                }
            }
            return(-1);
        }

        function updateLabelColors() {
            //Formatting changes are not supported by the api!
            //What we do instead is apply conditional formatting to cells, using formula =NOT(ISERROR(FIND(SUBSTITUTE(TEXT(ADDRESS(ROW(),COLUMN()), "")&",", "$",""),hidden!$A$2)))
            workbook.getRangeA1Async("hidden!A2", setHiddenValue, getLabelsStr(","));
        }

        function setHiddenValue(asyncResult) {
            asyncResult.getReturnValue().setValuesAsync([[asyncResult.getUserContext()]], setRangeValues, null);
        }

        function setRangeValues(asyncResult) {
        }

        function getLabelsStr(delimeter) {
            var labelsList = "";
            for (var i = 0; i < labels.length; i++) {
                labelsList += labels[i][0] + delimeter;
            };
            return labelsList;
        }

        function btnNextClick() {
            postData()
        }

        function postData() {
            var posting = $.post("get.aspx", {
                spreadsheet: workbook.getWorkbookPath(),
                spToken: spToken,
                cell: questionCell.getAddressA1(),
                labels: labels
            });

            //posting.done(function (data) {
            //    alert("done!");
            //});
        }

    </script>

    <div id="results"></div>
    </body>
</html>